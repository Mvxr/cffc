<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>DeepWeb Sklep</title>
  <style>
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background: black;
      color: #00cc66;
      overflow-x: hidden;
    }
    canvas#matrix {
      position: fixed;
      top: 0; left: 0;
      z-index: -1;
      width: 100%; height: 100%;
    }
    h1 { text-align:center; margin:20px 0; font-size:36px; text-shadow:0 0 10px #009933; }
    .container { max-width:1000px; margin:auto; padding:20px; }
    .top-bar { text-align:center; margin-bottom:30px; }
    .top-bar input {
      padding:8px; border-radius:5px; border:1px solid #00cc66;
      background:black; color:#00cc66; width:220px;
    }
    .btn { margin-left:10px; background:#111; color:#00cc66; border:1px solid #00cc66; padding:8px 15px; border-radius:5px; cursor:pointer; transition:0.3s; }
    .btn:hover { background:#00cc66; color:black; }
    .product-list { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom:40px; }
    .card { background:rgba(0,0,0,0.8); border:1px solid #00cc66; padding:20px; border-radius:10px; text-align:center; box-shadow:0 0 15px rgba(0,204,102,0.3); }
    .btn-order { margin-top:10px; background:#111; color:#00cc66; border:1px solid #00cc66; padding:10px 15px; border-radius:5px; cursor:pointer; transition:0.3s; }
    .btn-order:hover { background:#00cc66; color:black; }
    .btn-order:disabled { background:#222; color:#555; border-color:#333; cursor:not-allowed; }
    .orders { background:rgba(0,0,0,0.8); border:1px solid #00cc66; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,204,102,0.3); }
    .orders h2 { margin-bottom:15px; }
    .orders ul { list-style:none; padding:0; }
    .orders li { padding:8px 0; border-bottom:1px solid #003300; }
  </style>
</head>
<body>
<canvas id="matrix"></canvas>
<div class="container">
  <h1>üíÄ DeepWeb Sklep üíÄ</h1>
  <div class="top-bar">
    <input type="text" id="username" placeholder="Twoje imiƒô/pseudonim..." />
    <button class="btn" onclick="resetOrders()">üîÑ Reset zam√≥wie≈Ñ</button>
    <button class="btn" onclick="toggleMatrix()">üü¢ Matrix ON/OFF</button>
  </div>
  <div class="product-list" id="product-list"></div>
  <div class="orders">
    <h2>üìã Zam√≥wienia (wsp√≥lne)</h2>
    <ul id="order-list"></ul>
  </div>
</div>

<script>
const API_ORDERS = "https://68bf6d0f9c70953d96ef897c.mockapi.io/v1/orders";
const API_PRODUCTS = "https://68bf6d0f9c70953d96ef897c.mockapi.io/v1/products";

let orders = [];
let products = [];
let matrixEnabled = true;

// === FUNKCJA SPRAWDZAJƒÑCA HAS≈ÅO PRZEZ NETLIFY FUNCTION ===
async function verifyPassword(type) {
  const entered = prompt(type === "access" ? "üîí Podaj has≈Ço dostƒôpu do strony:" : "üõë Podaj has≈Ço do resetu:");
  if (!entered) return false;
  const res = await fetch("/.netlify/functions/check-pass", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({type,password:entered})
  });
  const data = await res.json();
  return data.success;
}

// === BLOKADA DOSTƒòPU DO STRONY ===
async function askForPassword() {
  const ok = await verifyPassword("access");
  if(!ok){
    alert("‚ùå B≈Çƒôdne has≈Ço! Dostƒôp zabroniony.");
    document.body.innerHTML="<h1 style='color:red;text-align:center;margin-top:50px;'>‚õî Brak dostƒôpu</h1>";
    throw new Error("Access denied");
  }
}

// === FETCH PRODUKT√ìW I ZAM√ìWIE≈É ===
async function fetchProducts() {
  const res = await fetch(API_PRODUCTS);
  products = await res.json();
  renderProducts();
}
async function fetchOrders() {
  const res = await fetch(API_ORDERS);
  orders = await res.json();
  renderOrders();
}

// === ZAM√ìWIENIE PRODUKTU ===
async function orderProduct(id){
  const username = document.getElementById("username").value.trim();
  if(!username){ alert("Podaj imiƒô/pseudonim!"); return; }

  let product = products.find(p=>p.id===String(id));
  if(product && Number(product.stock)>0){
    const newStock = Number(product.stock)-1;
    const updatedProduct = { product_name: product.product_name, price:Number(product.price), stock:newStock };
    await fetch(`${API_PRODUCTS}/${product.id}`,{
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(updatedProduct)
    });
    await fetch(API_ORDERS,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ user:username, product:product.product_name, date:new Date().toLocaleString() })
    });
    fetchProducts();
    fetchOrders();
  } else alert("‚ùå Produkt niedostƒôpny!");
}

// === RESET ZAM√ìWIE≈É ===
async function resetOrders(){
  const ok = await verifyPassword("reset");
  if(!ok){ alert("‚ùå Z≈Çe has≈Ço. Reset przerwany."); return; }
  if(!confirm("Na pewno usunƒÖƒá wszystkie zam√≥wienia?")) return;
  for(let o of orders){
    await fetch(`${API_ORDERS}/${o.id}`,{method:"DELETE"});
  }
  fetchOrders();
  alert("‚úÖ Zam√≥wienia zresetowane!");
}

// === RENDER PRODUKT√ìW ===
function renderProducts(){
  const container = document.getElementById("product-list");
  container.innerHTML="";
  products.forEach(prod=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h2>${prod.product_name}</h2>
      <p><b>Cena:</b> ${Number(prod.price).toFixed(2)} z≈Ç</p>
      <p><b>Dostƒôpne:</b> ${Number(prod.stock)} szt.</p>
      <button class="btn-order" onclick="orderProduct('${prod.id}')" ${Number(prod.stock)===0?"disabled":""}>Zam√≥w</button>
    `;
    container.appendChild(div);
  });
}

// === RENDER ZAM√ìWIE≈É (AGREGACJA xN) ===
function renderOrders(){
  const list = document.getElementById("order-list");
  list.innerHTML="";
  if(orders.length===0){ list.innerHTML="<li>Brak zam√≥wie≈Ñ</li>"; return; }

  const agg={};
  orders.forEach(o=>{
    const key=`${o.user}|${o.product}`;
    if(agg[key]) agg[key].count+=1;
    else agg[key]={user:o.user, product:o.product, count:1};
  });

  Object.values(agg).forEach(o=>{
    const li=document.createElement("li");
    li.textContent=`üë§ ${o.user} zam√≥wi≈Ç(a) ${o.product} x${o.count}`;
    list.appendChild(li);
  });
}

// === MATRIX ===
const canvas = document.getElementById("matrix");
const ctx = canvas.getContext("2d");
canvas.height=window.innerHeight; canvas.width=window.innerWidth;
const letters="01"; const fontSize=16; const columns=Math.floor(canvas.width/fontSize);
const drops=[]; for(let i=0;i<columns;i++) drops[i]=1;
function drawMatrix(){
  if(!matrixEnabled) return;
  ctx.fillStyle="rgba(0,0,0,0.1)"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#00aa44"; ctx.font=fontSize+"px monospace";
  for(let i=0;i<drops.length;i++){
    const text=letters.charAt(Math.floor(Math.random()*letters.length));
    ctx.fillText(text,i*fontSize,drops[i]*fontSize);
    if(drops[i]*fontSize>canvas.height && Math.random()>0.985) drops[i]=0;
    drops[i]+=0.5;
  }
}
setInterval(drawMatrix,70);
function toggleMatrix(){ matrixEnabled=!matrixEnabled; if(!matrixEnabled) ctx.clearRect(0,0,canvas.width,canvas.height); }

// === INIT ===
(async ()=>{
  try {
    await askForPassword();
    await fetchProducts();
    await fetchOrders();
  } catch(e){
    console.log("Dostƒôp do strony zablokowany");
  }
})();
</script>
</body>
</html>
